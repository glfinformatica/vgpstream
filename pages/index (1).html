<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>RTSPtoWeb MSE example</title>

    <style type="text/css">
      video { border: 1px solid black; }
    </style>
  </head>
  <body>
    <h1>RTSPtoWeb MSE example</h1>
    <input type="hidden" id="mse-url"
        value="ws://svn.ns0.it:8083/stream/otacos/channel/0/mse?uuid=otacos&channel=0">

    <video id="videoPlayer" autoplay muted playsinline width="100%"></video>


<script src="http://svn.ns0.it:8083/static/plugins/jquery/jquery.min.js"></script>
<script src="http://svn.ns0.it:8083/static/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="http://svn.ns0.it:8083/static/js/adminlte.min.js"></script>
<script src="http://svn.ns0.it:8083/static/plugins/sweetalert2/sweetalert2.min.js"></script>
<script src="http://svn.ns0.it:8083/static/js/index.js"></script>

    <script>
      // Extracted from RTSPtoWeb

      let mseQueue = [],
        mseSourceBuffer,
        mseStreamingStarted = false;

      function startPlay() {
        let videoEl = document.querySelector('#videoPlayer');
        let url = 'ws://svn.ns0.it:8083/stream/otacos/channel/0/mse?uuid=otacos&channel=0';

        //location.protocol == 'https:' ? protocol = 'wss' : protocol = 'ws';
        let mse = new MediaSource();
        //videoEl.src = window.URL.createObjectURL(mse);
		videoEl.src = window.URL.createObjectURL(mse);
		
		mse.addEventListener('sourceopen', function() {
          let ws = new WebSocket(url);
          ws.binaryType = 'arraybuffer';
          ws.onopen = function(event) {
            console.log('Connect to ws');
          }
          ws.onmessage = function(event) {
            let data = new Uint8Array(event.data);
            if (data[0] == 9) {
              decoded_arr = data.slice(1);
              if (window.TextDecoder) {
                mimeCodec = new TextDecoder('utf-8').decode(decoded_arr);
              } else {
                mimeCodec = Utf8ArrayToStr(decoded_arr);
              }
              mseSourceBuffer = mse.addSourceBuffer('video/mp4; codecs="' + mimeCodec + '"');
              mseSourceBuffer.mode = 'segments'
              mseSourceBuffer.addEventListener('updateend', pushPacket);

            } else {
              readPacket(event.data);
            }
          };
        }, false);

      }
	  
	function pushPacket() {
        let videoEl = document.querySelector('#videoPlayer');

        if (!mseSourceBuffer.updating) {
          if (mseQueue.length > 0) {
            packet = mseQueue.shift();
            mseSourceBuffer.appendBuffer(packet);
          } else {
            mseStreamingStarted = false;
          }
        }
        if (videoEl.buffered.length > 0) {
          if (typeof document.hidden !== 'undefined' && document.hidden) {
            //no sound, browser paused video without sound in background
            videoEl.currentTime = videoEl.buffered.end((videoEl.buffered.length - 1)) - 0.5;
          }
        }
      }

      function readPacket(packet) {
        if (!mseStreamingStarted) {
          mseSourceBuffer.appendBuffer(packet);
          mseStreamingStarted = true;
          return;
        }
        mseQueue.push(packet);
        if (!mseSourceBuffer.updating) {
          pushPacket();
        }
      }
	  

      document.addEventListener('DOMContentLoaded', function() {
        let videoEl = document.querySelector('#videoPlayer');

        videoEl.addEventListener('loadeddata', () => {
          videoEl.play();
        });

        //fix stalled video in safari
        videoEl.addEventListener('pause', () => {
          if (videoEl.currentTime > videoEl.buffered.end(videoEl.buffered.length - 1)) {
            videoEl.currentTime = videoEl.buffered.end(videoEl.buffered.length - 1) - 0.1;
            videoEl.play();
          }
        });

        videoEl.addEventListener('error', (e) => {
          console.log('video_error', e)
        });

        startPlay();
      });

    </script>

  </body>
</html>
